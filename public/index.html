<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SeaRoute Visualizer - Enhanced Global Ports</title>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        background: #0f172a;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      #map {
        position: absolute;
        inset: 0;
      }
      .sidebar {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 380px;
        z-index: 10;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
      }
      .sidebar::-webkit-scrollbar {
        width: 6px;
      }
      .sidebar::-webkit-scrollbar-track {
        background: transparent;
      }
      .sidebar::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 3px;
      }
      .card {
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(12px);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }
      .port-input {
        width: 100%;
        background: #1e293b;
        color: white;
        padding: 11px 14px;
        border: 1px solid #4b5563;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
      }
      .port-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }
      .ship-marker {
        background-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIxOCIgZmlsbD0iI0VGNDQ0NCIgb3BhY2l0eT0iMC4zIi8+CiAgPHBhdGggZD0iTTI4IDIySDIwTDE4IDE0SDE0TDEyIDhIMTBMOCAxNEg0TDIgMjJINEM0IDI0LjIgNS44IDI0IDYgMjRDNi4yIDI0IDggMjQuMiA4IDIySDI0QzI0IDI0LjIgMjUuOCAyNCAyNiAyNEMyNi4yIDI0IDI4IDI0LjIgMjggMjJaTTEwIDEySDE0TDE1IDE2SDExTDEwIDEyWk0xNiAxOEgxNEwxNSAxNkgxN0wxNiAxOFoiIGZpbGw9IiNGRkZGRkYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDYsIDYpIi8+CiAgPGNpcmNsZSBjeD0iMTIiIGN5PSIyOCIgcj0iMiIgZmlsbD0iIzFhMWExYSIvPgogIDxjaXJjbGUgY3g9IjI4IiBjeT0iMjgiIHI9IjIiIGZpbGw9IiMxYTFhMWEiLz4KPC9zdmc+");
        background-size: cover;
        width: 40px;
        height: 40px;
        animation: bobbing 2.5s ease-in-out infinite;
        filter: drop-shadow(0 4px 8px rgba(239, 68, 68, 0.6));
      }
      @keyframes bobbing {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(-8px) rotate(-2deg);
        }
      }
      .legend {
        position: absolute;
        bottom: 100px;
        right: 24px;
        background: rgba(30, 41, 59, 0.95);
        border-radius: 10px;
        padding: 14px 18px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 10;
        font-size: 13px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .legend-item:last-child {
        margin-bottom: 0;
      }
      .legend-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .loading-dots {
        display: inline-flex;
        gap: 4px;
      }
      .loading-dots span {
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .loading-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .loading-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
      .stat-card {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1) 0%,
          rgba(37, 99, 235, 0.05) 100%
        );
        padding: 16px;
        border-radius: 10px;
        border: 1px solid rgba(59, 130, 246, 0.2);
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="card">
        <h1
          class="text-2xl font-bold mb-6 text-blue-400 flex items-center gap-3"
        >
          <span class="text-3xl">üåä</span>
          <span>SeaRoute Pro</span>
        </h1>
        <div class="space-y-4">
          <div>
            <label
              class="text-xs text-gray-400 uppercase mb-2 block font-semibold"
              >Origin Port</label
            >
            <input
              list="origin-list"
              id="origin-input"
              class="port-input"
              placeholder="Start typing port name..."
            />
            <datalist id="origin-list"></datalist>
          </div>
          <div>
            <label
              class="text-xs text-gray-400 uppercase mb-2 block font-semibold"
              >Destination Port</label
            >
            <input
              list="dest-list"
              id="dest-input"
              class="port-input"
              placeholder="Start typing port name..."
            />
            <datalist id="dest-list"></datalist>
          </div>
          <button
            onclick="calculateRoute()"
            id="calc-btn"
            class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3 rounded-lg transition shadow-lg mt-4"
          >
            üö¢ Generate Sea Route
          </button>
        </div>
        <div
          id="results"
          class="hidden mt-6 pt-6 border-t border-gray-700 space-y-4"
        >
          <div class="grid grid-cols-2 gap-3">
            <div class="stat-card">
              <p class="text-xs text-gray-400 mb-1">Distance</p>
              <p class="text-2xl font-bold text-white" id="dist-display">‚Äî</p>
            </div>
            <div class="stat-card">
              <p class="text-xs text-gray-400 mb-1">Est. Time</p>
              <p class="text-2xl font-bold text-blue-400" id="time-display">
                ‚Äî
              </p>
            </div>
          </div>
          <div
            class="bg-gradient-to-br from-blue-950 to-slate-950 p-4 rounded-lg border border-blue-800/40 shadow-lg"
          >
            <p class="text-sm text-blue-300 mb-3 flex items-center gap-2">
              <span>üå§Ô∏è</span>
              <span class="font-semibold">Destination Weather</span>
            </p>
            <div class="flex justify-between items-center">
              <div>
                <span id="weather-temp" class="text-4xl font-bold">‚Äî</span>
                <span
                  id="weather-desc"
                  class="block text-sm capitalize mt-2 text-gray-300"
                  >‚Äî</span
                >
              </div>
              <div class="text-right text-sm space-y-1">
                <p class="text-gray-300">üí® <span id="weather-wind">‚Äî</span></p>
                <p class="text-gray-300">
                  üíß <span id="weather-humid">‚Äî</span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card text-sm">
        <div class="space-y-2">
          <p class="flex justify-between">
            <span class="text-gray-400">Total Ports:</span>
            <span id="port-count" class="text-blue-400 font-bold"
              >Loading...</span
            >
          </p>
          <p class="flex justify-between">
            <span class="text-gray-400">Route Status:</span>
            <span id="route-status" class="text-yellow-400 font-semibold"
              >Inactive</span
            >
          </p>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend">
      <div class="text-xs font-bold text-gray-300 mb-3">MAP LEGEND</div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #3b82f6"></div>
        <span>Port Clusters</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #ef4444"></div>
        <span>Active Ship</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #00eaff"></div>
        <span>Sea Route</span>
      </div>
    </div>

    <script>
      // Config
      const MAPBOX_TOKEN =
        "pk.eyJ1IjoidmVkYW50cmFqaGFucyIsImEiOiJjbWdtZTN6OWkxYzc2MmxzZ2JvOWI4YWxxIn0.d1gM0C5MHs0gQ2TfHj2o0Q";
      const OWM_KEY = "99a7d00880dbdf5fe9668693ab588b9d";
      const SERVER_URL = "/get_route";
      const PORTS_DATA_URL =
        "https://raw.githubusercontent.com/tayljordan/ports/main/ports.json";

      let portsData = [];
      let originCoords = null;
      let destCoords = null;
      let shipMarker = null;

      // Map initialization
      mapboxgl.accessToken = MAPBOX_TOKEN;
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/dark-v11",
        center: [20, 20],
        zoom: 2.2,
        projection: "globe",
      });

      map.on("load", () => {
        // Add atmospheric fog
        map.setFog({
          color: "rgb(10, 10, 20)",
          "high-color": "rgb(0, 0, 0)",
          "horizon-blend": 0.15,
          "space-color": "rgb(5, 5, 15)",
          "star-intensity": 0.6,
        });

        // Load global ports data
        axios
          .get(PORTS_DATA_URL)
          .then((res) => {
            portsData = res.data.filter((p) => p.LATITUDE && p.LONGITUDE);
            console.log(`‚úÖ Loaded ${portsData.length} ports`);
            document.getElementById("port-count").textContent =
              portsData.length.toLocaleString();

            // Create GeoJSON features
            const features = portsData.map((p) => ({
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [parseFloat(p.LONGITUDE), parseFloat(p.LATITUDE)],
              },
              properties: {
                name: p.CITY || "Unknown",
                country: p.COUNTRY || "Unknown",
                fullName: `${p.CITY || "Unknown"}, ${p.COUNTRY || "Unknown"}`,
              },
            }));

            // Add clustered port source
            map.addSource("ports", {
              type: "geojson",
              data: { type: "FeatureCollection", features },
              cluster: true,
              clusterMaxZoom: 12,
              clusterRadius: 50,
            });

            // Cluster circles
            map.addLayer({
              id: "clusters",
              type: "circle",
              source: "ports",
              filter: ["has", "point_count"],
              paint: {
                "circle-color": [
                  "step",
                  ["get", "point_count"],
                  "#3b82f6",
                  50,
                  "#60a5fa",
                  200,
                  "#93c5fd",
                ],
                "circle-radius": [
                  "step",
                  ["get", "point_count"],
                  22,
                  50,
                  32,
                  200,
                  42,
                ],
                "circle-opacity": 0.85,
                "circle-stroke-width": 2,
                "circle-stroke-color": "#ffffff",
                "circle-stroke-opacity": 0.3,
              },
            });

            // Cluster count labels
            map.addLayer({
              id: "cluster-count",
              type: "symbol",
              source: "ports",
              filter: ["has", "point_count"],
              layout: {
                "text-field": "{point_count_abbreviated}",
                "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                "text-size": 14,
              },
              paint: {
                "text-color": "#ffffff",
              },
            });

            // Unclustered ports
            map.addLayer({
              id: "unclustered-ports",
              type: "symbol",
              source: "ports",
              filter: ["!", ["has", "point_count"]],
              layout: {
                "icon-image": "harbor-15",
                "icon-size": 1.5,
                "text-field": ["get", "name"],
                "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
                "text-offset": [0, 1.5],
                "text-anchor": "top",
                "text-size": 11,
                "text-max-width": 10,
              },
              paint: {
                "icon-opacity": 0.9,
                "text-color": "#a5b4fc",
                "text-halo-color": "#0f172a",
                "text-halo-width": 1.8,
                "text-halo-blur": 1,
              },
            });

            // Populate datalists
            const originList = document.getElementById("origin-list");
            const destList = document.getElementById("dest-list");
            portsData.forEach((p) => {
              const name = `${p.CITY || "Unknown"}, ${p.COUNTRY || "Unknown"}`;
              const coords = JSON.stringify([
                parseFloat(p.LONGITUDE),
                parseFloat(p.LATITUDE),
              ]);
              const opt1 = document.createElement("option");
              opt1.value = name;
              opt1.dataset.coords = coords;
              originList.appendChild(opt1);

              const opt2 = document.createElement("option");
              opt2.value = name;
              opt2.dataset.coords = coords;
              destList.appendChild(opt2);
            });

            console.log("‚úÖ Port search enabled with autocomplete");
          })
          .catch((err) => {
            console.error("‚ùå Failed to load ports:", err);
            document.getElementById("port-count").textContent = "Error";
          });

        // Click handlers (clusters & individual ports)
        map.on("click", "unclustered-ports", (e) => {
          const feature = e.features[0];
          const coords = feature.geometry.coordinates.slice();
          const props = feature.properties;
          new mapboxgl.Popup({ offset: 25 })
            .setLngLat(coords)
            .setHTML(
              `
            <div style="color:#fff; min-width:240px; font-size:14px; padding:4px;">
              <div style="font-size:16px; font-weight:700; color:#60a5fa; margin-bottom:8px;">
                ‚öì ${props.fullName}
              </div>
              <div style="color:#94a3b8; font-size:12px; margin-bottom:6px;">
                üìç ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}
              </div>
            </div>
            `,
            )
            .addTo(map);
        });

        map.on("click", "clusters", (e) => {
          const features = map.queryRenderedFeatures(e.point, {
            layers: ["clusters"],
          });
          const clusterId = features[0].properties.cluster_id;
          map
            .getSource("ports")
            .getClusterExpansionZoom(clusterId, (err, zoom) => {
              if (err) return;
              map.easeTo({
                center: features[0].geometry.coordinates,
                zoom: zoom,
              });
            });
        });

        // Cursor changes
        ["unclustered-ports", "clusters"].forEach((layer) => {
          map.on(
            "mouseenter",
            layer,
            () => (map.getCanvas().style.cursor = "pointer"),
          );
          map.on(
            "mouseleave",
            layer,
            () => (map.getCanvas().style.cursor = ""),
          );
        });
      });

      // Route calculation
      async function calculateRoute() {
        const originVal = document.getElementById("origin-input").value.trim();
        const destVal = document.getElementById("dest-input").value.trim();

        if (!originVal || !destVal) {
          alert(
            "‚ö†Ô∏è Please select both origin and destination ports from the suggestions.",
          );
          return;
        }

        const originOpt = [
          ...document.querySelectorAll("#origin-list option"),
        ].find((o) => o.value === originVal);
        const destOpt = [
          ...document.querySelectorAll("#dest-list option"),
        ].find((o) => o.value === destVal);

        if (!originOpt || !destOpt) {
          alert(
            "‚ö†Ô∏è Please select valid ports from the autocomplete suggestions.",
          );
          return;
        }

        originCoords = JSON.parse(originOpt.dataset.coords);
        destCoords = JSON.parse(destOpt.dataset.coords);

        const btn = document.getElementById("calc-btn");
        const originalText = btn.innerHTML;
        btn.innerHTML =
          '<span class="loading-dots"><span></span><span></span><span></span></span> Calculating...';
        btn.disabled = true;

        try {
          const res = await axios.post(SERVER_URL, {
            origin: originCoords,
            dest: destCoords,
          });
          const data = res.data;

          drawRoute(data.geometry);

          // Ship marker at origin
          if (shipMarker) shipMarker.remove();
          const shipEl = document.createElement("div");
          shipEl.className = "ship-marker";
          shipMarker = new mapboxgl.Marker(shipEl)
            .setLngLat(originCoords)
            .setPopup(
              new mapboxgl.Popup({ offset: 25 }).setHTML(`
                <div style="color:#fff; padding:8px;">
                  <strong style="color:#ef4444;">üö¢ Active Vessel</strong><br/>
                  <span style="font-size:12px;">Departing from ${originVal}</span>
                </div>
              `),
            )
            .addTo(map);

          // Weather at destination
          const weather = await fetchWeather(destCoords[1], destCoords[0]);

          // Travel time estimate (18 knots average speed)
          const speedKnots = 18;
          const days = (data.distance / (speedKnots * 24)).toFixed(1);

          document.getElementById("dist-display").textContent =
            `${Math.round(data.distance)} NM`;
          document.getElementById("time-display").textContent = `${days} days`;
          document.getElementById("route-status").textContent = "Active ‚úì";
          document.getElementById("route-status").className =
            "text-green-400 font-semibold";

          if (weather) {
            document.getElementById("weather-temp").textContent =
              `${Math.round(weather.main.temp)}¬∞C`;
            document.getElementById("weather-desc").textContent =
              weather.weather[0].description;
            document.getElementById("weather-wind").textContent =
              `${weather.wind.speed} m/s`;
            document.getElementById("weather-humid").textContent =
              `${weather.main.humidity}%`;
          }

          document.getElementById("results").classList.remove("hidden");

          // Fit map to route
          const bounds = new mapboxgl.LngLatBounds();
          data.geometry.coordinates.forEach((c) => bounds.extend(c));
          map.fitBounds(bounds, {
            padding: { top: 100, bottom: 100, left: 450, right: 100 },
            duration: 2000,
          });

          console.log("‚úÖ Route calculated successfully");
        } catch (err) {
          console.error("‚ùå Route calculation error:", err);
          alert(
            "‚ùå Failed to calculate route. Please try again or refresh the page.",
          );
        } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      async function fetchWeather(lat, lon) {
        try {
          const res = await axios.get(
            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OWM_KEY}`,
          );
          return res.data;
        } catch (err) {
          console.error("Weather fetch failed:", err);
          return null;
        }
      }

      function drawRoute(geometry) {
        if (map.getSource("route")) {
          map.removeLayer("route");
          map.removeLayer("route-glow");
          map.removeSource("route");
        }

        map.addSource("route", {
          type: "geojson",
          data: { type: "Feature", geometry },
        });

        map.addLayer({
          id: "route-glow",
          type: "line",
          source: "route",
          paint: {
            "line-color": "#00eaff",
            "line-width": 8,
            "line-blur": 6,
            "line-opacity": 0.5,
          },
        });

        map.addLayer({
          id: "route",
          type: "line",
          source: "route",
          paint: {
            "line-color": "#00eaff",
            "line-width": 3,
          },
        });
      }

      console.log("üåä SeaRoute Visualizer Pro - Enhanced Edition");
      console.log("‚úÖ Map initialized with globe projection");
      console.log("‚úÖ Loading global ports data...");
    </script>
  </body>
</html>
